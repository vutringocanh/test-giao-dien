<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TikTok Gift Overlay</title>

<style>
/* ===== NỀN TRONG SUỐT TUYỆT ĐỐI ===== */
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    overflow: hidden;
    pointer-events: none; /* click xuyên */
}

/* ===== VIDEO ===== */
.video-box {
    position: fixed;
    bottom: 40px;
    right: 40px;
}

video {
    width: 300px;
    border-radius: 20px;
    display: none;
    box-shadow: 0 0 30px rgba(255, 105, 180, 0.8);
}
</style>
</head>

<body>

<div class="video-box">
    <video id="giftVideo"
        muted
        playsinline
        src="https://vutringocanh.github.io/video/video.mp4">
    </video>
</div>

<script>
/* =============================
   VIDEO + SPAM CONTROL
============================= */

const giftVideo = document.getElementById("giftVideo");

let isPlaying = false;
let lastPlayTime = 0;
const COOLDOWN = 4000; // 4 giây
let queue = 0;

function tryPlayVideo() {
    const now = Date.now();

    if (isPlaying) return;

    if (now - lastPlayTime < COOLDOWN) return;

    if (queue <= 0) return;

    queue--;
    isPlaying = true;
    lastPlayTime = now;

    giftVideo.style.display = "block";
    giftVideo.currentTime = 0;

    giftVideo.play().catch(() => {});
}

giftVideo.addEventListener("ended", () => {
    giftVideo.style.display = "none";
    isPlaying = false;

    setTimeout(tryPlayVideo, 500); // kiểm tra hàng đợi
});

/* =============================
   SSE CONNECT (GIỮ NGUYÊN)
============================= */

let eventSource = new EventSource("http://localhost:5001/events");

eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleMessage(data);
};

function handleMessage(data) {
    if (data.type !== "gift") return;

    const giftName = (data.gift || "").toLowerCase();
    const count = data.count || 1;

    // ===== ROSE =====
    if (giftName.includes("ros")) {
        queue += Math.min(count, 3); // giới hạn gộp
        tryPlayVideo();
    }
}
</script>

</body>
</html>
